{% assign main_menu_linklist = linklists[section.settings.menu] %}
{% assign search_menu_linklist = linklists[section.settings.menu] %}


{% comment %}
  {% if section.settings.enable_announcement %}
    <!-- Fixed announcement bar (Headroom-compatible) -->
    <div
      id="announcement-bar"
      class="announcement__banner fixed top-0 left-0 w-full z-20 bg-[#d6d2c4] border-b border-[rgba(33,35,34,0.2)] text-center flex items-center py-2"
    >
      <div class="relative w-full max-w-[700px] mx-auto px-0">
        {% if section.blocks.size > 1 %}
          <!-- Arrow Left -->
          <button
            class="arrow-btn arrow-left absolute top-1/2 left-0 z-10 -translate-y-1/2 cursor-pointer bg-transparent border-none pl-2"
            id="prevBtn"
            aria-label="Previous"
          >
            {% render 'icon-left-arrow', class: 'size-5 md:size-6' %}
          </button>

          <!-- Arrow Right -->
          <button
            class="arrow-btn arrow-right absolute top-1/2 right-0 z-10 -translate-y-1/2 cursor-pointer bg-transparent border-none pr-2"
            id="nextBtn"
            aria-label="Next"
          >
            {% render 'icon-right-arrow', class: 'size-5 md:size-6' %}
          </button>
        {% endif %}

        <!-- Slider Container -->
        <div class="announcement-bar slider-container w-full max-w-2xl mx-auto overflow-hidden px-2 md:px-0">
          <div id="sliderWrapper" class="slider-wrapper flex transition-transform duration-300 ease-in-out">
            {% if section.blocks.size > 0 %}
              {% for block in section.blocks %}
                <div class="slide flex items-center justify-center min-w-full px-4 md:px-0">
                  <p class="max-w-lg px-4 text-[11px] md:text-xs uppercase">
                    {{ block.settings.text }}
                    {% if block.settings.link != blank %}
                      <span class="ml-0.5">
                        <a
                          class="underline text-[#212322] opacity-70 hover:opacity-100 transition-opacity duration-200"
                          href="{{ block.settings.link }}"
                        >
                          {{ block.settings.link_text }}
                        </a>
                      </span>
                    {% endif %}
                  </p>
                </div>
              {% endfor %}
            {% else %}
              <div class="slide flex items-center justify-center min-w-full px-4 md:px-0">
                <p class="max-w-lg px-4 text-[11px] md:text-xs uppercase">
                  FREE SHIPPING ON ORDERS $40+
                  <span class="ml-0.5">
                    <a
                      class="underline text-[#212322] opacity-70 hover:opacity-100 transition-opacity duration-200"
                      href="{{ routes.all_products_collection_url }}"
                    >
                      SHOP NOW
                    </a>
                  </span>
                </p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <button
        class="close-announcement-banner pl-1 px-2 py-3 cursor-pointer"
        id="announcement-dismiss"
        aria-label="Dismiss"
      >
        {% render 'icon-close' %}
      </button>
    </div>
  {% endif %}
{% endcomment %}

<!-- END OF ANNOUNCEMENT BAR -->

<!-- START OF HEADER -->
<div id="site-header" class="bg-[#d6d2c4] fixed top-0 left-0 w-full z-30" style="top: var(--bar-h, 0px);">
  <div class="relative h-14 md:h-auto md:pt-4 xl:pt-0 xl:h-[88px] ">
    <!-- START OF LOGO -->
    <div class="flex items-center justify-center z-[3]XX h-full">
      <a class="block" href="{{ shop.url }}">
        <img
          class="mx-auto h-9 w-[150px] object-contain md:h-13 md:w-full"
          src="{{ 'Papatui_Header_Logo.png' | asset_url }}"
          alt=""
          srcset=""
        >
      </a>
    </div>
    <!-- END OF LOGO -->

    <div
      id="mobile-nav-button_open"
      class="absolute top-0 left-[18px] h-full flex items-center cursor-pointer z-[4]XX md:hidden"
    >
      <!-- BARS ICON -->
      {% render 'icon-bars' %}
    </div>

    <div class="absolute top-0 right-[18px] h-full flex items-center gap-3  z-[4]XX xl:right-[30px] md:gap-8">
      <a href="{{ routes.account_url }}" class="hidden items-center relative cursor-pointer md:flex">
        <!-- USER ICON -->
        {% render 'icon-account-user' %}
      </a>
      <a
        href="{{ routes.cart_url }}"
        data-cart-open
        aria-controls="cart-root"
        aria-expanded="false"
        aria-haspopup="dialog"
        class=" flex items-center relative cursor-pointer"
      >
        <!-- CART ICON -->
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-5"
        >
          <path stroke-linecap="round" stroke-linejoin="round"
              d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
        </svg>
        <div class="relative">
          <span
            id="CartCount"
            class="absolute -top-[12px] -right-[5px] min-w-[14px] leading-[12px] text-[9px] px-[3px] py-[1px] text-center text-white tracking-[0] rounded-[15px] bg-[#212322]"
          >
            {{ cart.item_count }}
          </span>
        </div>
      </a>
      <div class="nav-search-button  flex items-center cursor-pointer">
        <!-- SEARCH ICON -->
        {% render 'icon-search' %}
      </div>
    </div>
  </div>

  <!-- START OF MD:NAV -->
  <nav>
    <ul
      class="hidden md:flex items-center justify-center px-[18px] pb-4 sm:mt-4 xl:px-[30px] xl:mt-0 min-[1440px]:justify-start min-[1440px]:absolute min-[1440px]:px-0 min-[1440px]:pb-0 min-[1440px]:top-1/2 min-[1440px]:left-0 min-[1440px]:-translate-y-1/2 z-40"
    >
      {% for link in main_menu_linklist.links %}
        {% if link.links != blank %}
          <li
            id="medium-nav-list-item"
            class="first:pl-0  medium-nav-list-item px-[18px]  tracking-[1px] text-sm relative"
          >
            <a
              class="uppercase h-8 flex items-center justify-center hover:text-[rgba(33,35,34,0.7)] relative after:content-[''] after:absolute after:left-1/2 after:bottom-0 after:w-0 after:h-[2px] after:bg-[rgba(33,35,34,0.7)] after:transition-all after:duration-300 after:ease-in-out after:-translate-x-1/2 hover:after:w-full"
              href="{{ link.url }}"
            >
              {{ link.title }}
              <!-- DOWN ARROW ICON -->
              <span class="block pl-1.5">
                {% render 'icon-down-arrow' %}
              </span>
            </a>
            <ul
              id="medium-subnav-container"
              class="medium-subnav-container hidden opacity-0 transition-opacity duration-100 ease-in-out absolute bg-[#d6d2c4] px-[18px] py-[12px] min-w-[160px] max-w-[270px] w-max shadow-[0_8px_24px_rgba(33,35,34,0.08)] z-[40] lg:z-[40]"
            >
              {% for childlink in link.links %}
                <li class="text-[rgba(33,35,34,0.7)] leading-[1.5] w-full  text-xs ">
                  <a
                    class="block w-full px-[0.4em] py-[0.5em] rounded hover:bg-[rgba(33,35,34,0.1)]"
                    href="{{ childlink.url }}"
                  >
                    {{- childlink.title -}}
                  </a>
                </li>
              {% endfor %}
            </ul>
          </li>
        {% else %}
          <li id="medium-nav-list-item" class="first:pl-0 medium-nav-list-item px-[18px]  tracking-[1px] text-sm">
            <a
              class="uppercase h-8 flex items-center justify-center hover:text-[rgba(33,35,34,0.7)] relative after:content-[''] after:absolute after:left-1/2 after:bottom-0 after:w-0 after:h-[2px] after:bg-[rgba(33,35,34,0.7)] after:transition-all after:duration-300 after:ease-in-out after:-translate-x-1/2 hover:after:w-full"
              href="{{ link.url }}"
            >
              {{ link.title }}
            </a>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </nav>
  <!-- END OF MD:NAV -->
</div>
<div id="header-spacer" style="height: var(--header-h, 0px);"></div>

<!-- END OF HEADER -->

<!-- START OF MOBILE NAV -->
<div
  class="mobile__nav__drawer__bg fixed top-0 left-0 w-full h-full z-[40] bg-[#0b0b0b66] opacity-0 invisible transition-opacity duration-500 ease-in-out"
>
  <div
    class="mobile__nav__drawer__open fixed top-0 left-[-100%] z-[50] h-full w-[480px] max-w-[calc(100vw-24px)] overflow-hidden overflow-y-auto bg-white pb-[120px] transition-[left] duration-500 ease-in-out outline-none"
  >
    <!-- START OF MOBILE HEADER -->
    <div class="h-[72px] flex justify-between items-center">
      <div id="mobile-nav-button-close" class="ml-3 w-fit">
        <!-- X ICON -->
        {% render 'icon-close', class: 'size-8' %}
      </div>

      <div class="mr-3">
        <a href="{{ routes.account_url }}" class="flex items-center pt-[18px] pb-[18px] pl-[18px]">
          <!-- USER ICON -->
          {% render 'icon-account-user' %}

          <span class="pl-1.5 text-xs font-secondary">
            {%- if customer %}Account{% else %}Log in{% endif -%}
          </span>
        </a>
      </div>
    </div>
    <!-- END OF MOBILE HEADER -->
    <!-- START OF MOBILE MENU -->
    <ul class="ml-4.5 mr-3 divide-y divide-[rgba(33,35,34,0.2)]">
      {% for link in main_menu_linklist.links %}
        {% if link.links != blank %}
          <li class="mobile-menu-list-item">
            <a
              href="{{ link.url }}"
              class="mobile-menu-list-item__link text-xl py-7 tracking-[1px] flex items-center justify-between font-secondary"
            >
              <span class="block">{{ link.title }}</span>
              <!-- RIGHT ARROW ICON -->
              <span class="block">
                {% render 'icon-right-arrow' %}
              </span>
            </a>
            <div
              class="mobile-nav__subcontainer absolute top-0 bottom-0 right-[-100%] w-full h-full bg-white z-[60] overflow-y-scroll pb-[25px] transition-[right] duration-500 ease-in-out"
            >
              <div class="relative">
                <div class="relative">
                  {% if section.settings.mobilebanner != blank %}
                    <img
                      class="h-60 w-full object-cover"
                      src="{{ section.settings.mobilebanner | asset_url }}"
                      alt=""
                    >
                  {% else %}
                    <img
                      class="h-60 w-full object-cover"
                      src="{{ 'mobile-secondary-subnav-banner_completefacecare_scent_uncented__01.png' | asset_url }}"
                      alt=""
                    >
                  {% endif %}
                  <div
                    class="mobile-subnav__close-btn absolute top-[24px] left-[8px] cursor-pointer z-[60]"
                  >
                    <!-- X ICON -->
                    {% render 'icon-close', class: 'size-8', stroke: '#ffffff' %}
                  </div>
                </div>

                <div class="bg-white">
                  <div
                    class="mobile-subnav__back-btn text-xl py-7 tracking-[1px] flex items-center justify-center relative ml-2 mr-4.5"
                  >
                    <!-- LEFT ARROW ICON -->
                    <span class="block absolute left-1">
                      {% render 'icon-left-arrow' %}
                    </span>
                    <span class="block text-base font-secondary">{{ link.title }}</span>
                  </div>
                  <ul
                    class="mx-4.5 divide-y divide-[rgba(33,35,34,0.2)] border-t border-[rgba(33,35,34,0.2)]"
                  >
                    {% for childlink in link.links %}
                      <li>
                        <a href="{{ childlink.url }}" class="text-xl py-7 block tracking-[1px] font-secondary">
                          {{- childlink.title -}}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          </li>
        {% else %}
          <li class="mobile-menu-list-item">
            <a href="{{ link.url }}" class="text-xl py-7 block tracking-[1px] font-secondary">{{ link.title }}</a>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
    <!-- END OF MOBILE MENU -->
    <!-- START OF MOBILE SOCIALS -->
    <div class="ml-4.5 mr-3 flex items-center gap-2">
      <a class="w-7 h-7 flex items-center justify-center">
        <img
          class="w-5 h-5"
          src="{{ 'papatui_instagram.png' | asset_url }}"
          alt="{{ section.settings.mobilealt | default: '' | escape }}"
        >
      </a>
      <a class="w-7 h-7 flex items-center justify-center">
        <img
          class="w-5 h-5"
          src="{{ 'papatui-tiktok.png' | asset_url }}"
          alt="{{ section.settings.mobilealt | default: '' | escape }}"
        >
      </a>
    </div>
    <!-- END OF MOBILE SOCIALS -->
  </div>
</div>
<!-- END OF MOBILE NAV -->

<!-- START OF SEARCH SECTION -->

<div
  class="search-overlay absoluteXX top-0XX left-0XX w-fullXX h-fullXX fixed inset-0 z-[40] bg-[#0b0b0b66] opacity-0 invisible transition-opacity duration-500 ease-in-out"
>
  <form
    action="{{ routes.search_url }}"
    method="get"
    role="search"
    class="search-panel absoluteXX top-0XX left-0XX w-fullXX h-fullXX fixed inset-0 z-[50] overflow-hidden overflow-y-auto bg-white transition-transform duration-500 ease-in-out -translate-y-full sm:h-fit"
  >
    <div class="border-b border-b-[rgba(33,33,33,0.2)] px-[18px] ">
      <div class="flex justify-between items-center gap-5 h-[72px] max-w-screen-2xl mx-auto">
        <button type="submit">
          <!-- SEARCH ICON -->
          {% render 'icon-search' %}
        </button>
        <input
          class="text-base tracking-[1px] block w-full outline-0 placeholder:text-[rgba(33,33,33,0.5)] font-secondary placeholder:tracking-[1px]"
          type="search"
          name="q"
          placeholder="Search our store..."
        >
        <div class="search-close-button cursor-pointer">
          <!-- X ICON -->
          {% render 'icon-close', class: 'size-8' %}
        </div>
      </div>
    </div>

    <div
      class="py-[30px] px-[18px] max-w-screen-2xl mx-auto flex flex-col gap-[30px]"
    >
      <!-- Recent searches -->
      <div id="SearchRecent" data-search-url="{{ routes.search_url }}" class="hidden">
        <h4 class="text-sm uppercase mb-1.5 ml-1.5 tracking-[1px] leading-loose font-secondary">Recent searches</h4>
        <ul data-recent-list></ul>
      </div>

      {%- comment -%} WHEN SEARCH STARTS {%- endcomment -%}
      <div
        id="SearchSuggestWrap"
        class="pt-0 pb-[30px] max-w-screen-2xlXX mx-autoXX  gap-[30px]  hidden "
      >
        <div>
          <h4 class="text-sm uppercase mb-1.5 pl-1.5 tracking-[1px] leading-loose font-secondary">Products</h4>
          <ul data-suggest-products></ul>
        </div>
      </div>

      <div class="">
        <h4 class="text-sm uppercase mb-1.5 ml-1.5 tracking-[1px] leading-loose font-secondary">
          {{ search_menu_linklist.title }}
        </h4>
        <ul>
          {% for link in search_menu_linklist.links %}
            <li class="text-xs tracking-[1px]">
              <a
                class="py-[3px] px-1.5 block w-full lg:w-1/2 rounded hover:bg-[rgba(33,35,34,0.1)] leading-normal font-secondary"
                href="{{ link.url }}"
              >
                {{- link.title -}}
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="sticky bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-[rgba(33,33,33,0.2)]">
      <div class="max-w-screen-2xl mx-auto px-[24px] py-[18px]">
        <button
          type="submit"
          class="py-[9px] px-[18px] w-full bg-[#d6d2c4] text-[#3e4827] uppercase text-sm leading-[30px] tracking-[1px] transition-all duration-200 ease-in-out hover:bg-[#ccc7b5] cursor-pointer md:max-w-[360px]"
        >
          Search
        </button>
      </div>
    </div>
    <input type="hidden" name="type" value="product">
  </form>
</div>

<!-- END OF SEARCH SECTION -->
{% comment %} ANNOUNCEMENT SLIDER {% endcomment %}
{% comment %}
  <style>
    .slider-wrapper {
        display: flex;
        transition: transform 0.4s ease-in-out;
    }

    .slide {
        min-width: 100%;
    }

    .arrow-btn {
        background: none;
        border: none;
        cursor: pointer;
    }

    .slider-container {
        overflow: hidden;
        position: relative;
        max-width: 640px;
        margin: 0 auto;
    }


    .arrow-left {
        left: 0rem;
    }

    .arrow-right {
        right: 0rem;
    }

    @media (max-width: 480px) {
        .slider-container {
            width: 85%;
            padding-top: 4px;
            padding-bottom: 4px;
        }

        {% if section.blocks.size == 1 %}
          .slider-container {
            width: 100%;
        }
        {% endif %}
    }

    @media (min-width: 481px) and (max-width: 768px) {
        .slider-container {
            width: 80%;
        }
        {% if section.blocks.size == 1 %}
          .slider-container {
            width: 100%;
        }
        {% endif %}
    }

    @media (min-width: 769px) {
        .slider-container {
            width: 100%;
        }
    }
  </style>
{% endcomment %}

{% comment %} FIXED HEADER {% endcomment %}
<style>
  /* Smooth slide for both layers */
  #announcement-bar,
  #site-header {
    will-change: transform;
    transition: transform 200ms ease;
    transform: translateY(var(--header-shift, 0px));
  }
</style>

{% comment %} SEARCH  {% endcomment %}
<style>
  /* Chrome / Safari / Edge (Chromium) */
  input[type='search']::-webkit-search-cancel-button,
  input[type='search']::-webkit-search-decoration,
  input[type='search']::-webkit-search-results-button,
  input[type='search']::-webkit-search-results-decoration {
    -webkit-appearance: none;
    appearance: none;
    display: none;
  }

  /* Legacy Edge / IE */
  input[type='search']::-ms-clear,
  input[type='search']::-ms-reveal {
    display: none;
    width: 0;
    height: 0;
  }
</style>

{% comment %} FIXED HEADER AND ANNOUCEMENT BAR -- SCROLL ANIMATION {% endcomment %}
<!-- Headroom library -->


{% comment %} <script defer>
  document.addEventListener('DOMContentLoaded', function () {
    var header = document.getElementById('site-header');
    var spacer = document.getElementById('header-spacer');
    if (!header || !spacer) return;

    function cssNum(name, fallback) {
      var v = parseInt(getComputedStyle(document.documentElement).getPropertyValue(name), 10);
      return isNaN(v) ? fallback : v;
    }
    function setVar(name, px) {
      document.documentElement.style.setProperty(name, px + 'px');
    }
    function setShift(px) {
      document.documentElement.style.setProperty('--header-shift', px + 'px');
    }

    function measure() {
      var barH = cssNum('--bar-h', 0); // NEW: read bar height
      var headerH = Math.round(header.getBoundingClientRect().height);
      var stackH = barH + headerH; // NEW: total stack

      setVar('--hdr-h', headerH);
      // setVar('--stack-h', stackH); // optional if you want to reference later
      spacer.style.height = stackH + 'px'; // NEW: spacer = bar + header

      var curShift = getComputedStyle(document.documentElement).getPropertyValue('--header-shift').trim();
      if (curShift && curShift !== '0px') setShift(-stackH); // keep slide aligned
    }

    var hr = new Headroom(header, {
      offset: 0,
      tolerance: { up: 5, down: 5 },
      onPin: function () {
        setShift(0);
      },
      onUnpin: function () {
        var barH = cssNum('--bar-h', 0); // NEW
        var headerH = cssNum('--hdr-h', 0);
        setShift(-(barH + headerH)); // NEW
      },
      onTop: function () {
        setShift(0);
      },
    });
    hr.init();

    var ready = () => requestAnimationFrame(() => requestAnimationFrame(measure));
    document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', ready) : ready();
    window.addEventListener('load', measure, { passive: true });
    window.addEventListener('resize', measure, { passive: true });

    if ('ResizeObserver' in window) new ResizeObserver(measure).observe(header);
  });
</script> {% endcomment %}

<script defer>
  document.addEventListener('DOMContentLoaded', function () {
    var header = document.getElementById('site-header');
    var spacer = document.getElementById('header-spacer');
    if (!header || !spacer) return;

    function cssNum(name, fallback) {
      var v = parseInt(getComputedStyle(document.documentElement).getPropertyValue(name), 10);
      return isNaN(v) ? fallback : v;
    }
    function setVar(name, px) {
      document.documentElement.style.setProperty(name, px + 'px');
    }
    function setShift(px) {
      document.documentElement.style.setProperty('--header-shift', px + 'px');
    }

    // OPTIONAL: prevent re-entrant measure() calls
    let measuringHeader = false;

    function measure() {
      if (measuringHeader) return;           // <-- guard
      measuringHeader = true;

      var barH = cssNum('--bar-h', 0);       // read bar height
      var headerH = Math.round(header.getBoundingClientRect().height);
      var stackH = barH + headerH;           // total stack

      setVar('--hdr-h', headerH);
      spacer.style.height = stackH + 'px';   // spacer = bar + header

      var curShift = getComputedStyle(document.documentElement).getPropertyValue('--header-shift').trim();
      if (curShift && curShift !== '0px') setShift(-stackH); // keep slide aligned

      measuringHeader = false;
    }

    // 🔔 Listen for the announcement bar's custom "measured" event
    document.addEventListener('announcement:measured', function () {
      measure();
    });

    var hr = new Headroom(header, {
      offset: 0,
      tolerance: { up: 5, down: 5 },
      onPin: function () { setShift(0); },
      onUnpin: function () {
        var barH = cssNum('--bar-h', 0);
        var headerH = cssNum('--hdr-h', 0);
        setShift(-(barH + headerH));
      },
      onTop: function () { setShift(0); },
    });
    hr.init();

    // Initial + responsive measuring
    var ready = () => requestAnimationFrame(() => requestAnimationFrame(measure));
    document.readyState === 'loading' ? document.addEventListener('DOMContentLoaded', ready) : ready();
    window.addEventListener('load', measure, { passive: true });
    window.addEventListener('resize', measure, { passive: true });

    if ('ResizeObserver' in window) new ResizeObserver(measure).observe(header);
  });
</script>



{% comment %} MOBILE NAV {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // === Utility Functions ===
    const addClasses = (el, classes) => el?.classList.add(...classes.split(' '));
    const removeClasses = (el, classes) => el?.classList.remove(...classes.split(' '));

    const body = document.body;
    const drawerBg = document.querySelector('.mobile__nav__drawer__bg');
    const drawerPanel = document.querySelector('.mobile__nav__drawer__open');

    // === MOBILE NAV: Open ===
    document.getElementById('mobile-nav-button_open')?.addEventListener('click', function () {
      removeClasses(drawerBg, 'opacity-0 invisible');
      addClasses(drawerBg, 'opacity-100 visible');

      removeClasses(drawerPanel, 'left-[-100%]');
      addClasses(drawerPanel, 'left-0');

      addClasses(body, 'overflow-hidden');
    });

    // === MOBILE NAV: Close ===
    document.getElementById('mobile-nav-button-close')?.addEventListener('click', function () {
      removeClasses(drawerPanel, 'left-0');
      addClasses(drawerPanel, 'left-[-100%]');

      removeClasses(drawerBg, 'opacity-100 visible');
      addClasses(drawerBg, 'opacity-0');

      setTimeout(() => {
        addClasses(drawerBg, 'invisible');
        removeClasses(body, 'overflow-hidden');
      }, 500);
    });

    // === MOBILE SUBNAV: Open ===
    document.querySelectorAll('.mobile-menu-list-item__link').forEach((link) => {
      link.addEventListener('click', function (e) {
        e.preventDefault();

        const listItem = this.closest('.mobile-menu-list-item');
        const subContainer = listItem?.querySelector('.mobile-nav__subcontainer');
        if (subContainer) {
          removeClasses(subContainer, 'right-[-100%]');
          addClasses(subContainer, 'right-0');
        }

        const backBtnWrap = this.closest('.mobile-subnav__back-btn');
        const previousSub = backBtnWrap?.querySelector('.mobile-nav__subcontainer');
        if (previousSub) {
          removeClasses(previousSub, 'right-0');
          addClasses(previousSub, 'right-[-100%]');
        }
      });
    });

    // === MOBILE SUBNAV: Back Button ===
    document.querySelectorAll('.mobile-subnav__back-btn').forEach((btn) => {
      btn.addEventListener('click', function () {
        const subnav = this.closest('.mobile-nav__subcontainer');
        if (subnav) {
          removeClasses(subnav, 'right-0');
          addClasses(subnav, 'right-[-100%]');
        }
      });
    });

    // === MOBILE SUBNAV: Close Button (X) ===
    document.querySelectorAll('.mobile-subnav__close-btn').forEach((btn) => {
      btn.addEventListener('click', function () {
        document.querySelectorAll('.mobile-nav__subcontainer').forEach((el) => {
          removeClasses(el, 'right-0');
          addClasses(el, 'right-[-100%]');
        });

        removeClasses(drawerPanel, 'left-0');
        addClasses(drawerPanel, 'left-[-100%]');

        removeClasses(drawerBg, 'opacity-100 visible');
        addClasses(drawerBg, 'opacity-0');

        setTimeout(() => {
          addClasses(drawerBg, 'invisible');
          removeClasses(body, 'overflow-hidden');
        }, 500);
      });
    });

    // === MEDIUM NAV: Hover to Fade In/Out ===
    document.querySelectorAll('.medium-nav-list-item').forEach((item) => {
      const submenu = item.querySelector('.medium-subnav-container');
      if (!submenu) return;

      item.addEventListener('mouseenter', () => {
        submenu.style.display = 'block';
        requestAnimationFrame(() => {
          submenu.style.opacity = '1';
        });
      });

      item.addEventListener('mouseleave', () => {
        submenu.style.opacity = '0';
        setTimeout(() => {
          submenu.style.display = 'none';
        }, 125);
      });
    });
  });
</script>

{% comment %} SEARCH COMPONENT {% endcomment %}
<script>
  // helpers (yours)
  const addClasses = (el, cls) => cls.split(' ').forEach((c) => el.classList.add(c));
  const removeClasses = (el, cls) => cls.split(' ').forEach((c) => el.classList.remove(c));

  const body = document.body;

  function openSearchPanel() {
    const overlay = document.querySelector('.search-overlay');
    const panel = document.querySelector('.search-panel');
    if (!overlay || !panel) return;

    // overlay fade in
    removeClasses(overlay, 'opacity-0 invisible');
    addClasses(overlay, 'opacity-100 visible');

    // panel slide in (transform-based)
    removeClasses(panel, '-translate-y-full');
    addClasses(panel, 'translate-y-0');

    addClasses(body, 'overflow-hidden');
  }

  function closeSearchPanel() {
    const overlay = document.querySelector('.search-overlay');
    const panel = document.querySelector('.search-panel');
    if (!overlay || !panel) return;

    // panel slide out
    removeClasses(panel, 'translate-y-0');
    addClasses(panel, '-translate-y-full');

    // overlay fade out
    removeClasses(overlay, 'opacity-100 visible');
    addClasses(overlay, 'opacity-0');

    // after transition ends, make it non-interactive & re-enable page scroll
    setTimeout(() => {
      addClasses(overlay, 'invisible');
      removeClasses(body, 'overflow-hidden');
    }, 500); // match your transition duration
  }

  // === SEARCH PANEL: Open ===
  document.querySelectorAll('.nav-search-button').forEach((btn) => {
    btn.addEventListener('click', openSearchPanel);
  });

  // === SEARCH PANEL: Close (X button) ===
  document.querySelectorAll('.search-close-button').forEach((btn) => {
    btn.addEventListener('click', closeSearchPanel);
  });

  // Close when clicking the dim background
  document.addEventListener('click', (e) => {
    const overlay = document.querySelector('.search-overlay');
    const panel = document.querySelector('.search-panel');
    if (!overlay || !panel) return;
    const isOpen = !overlay.classList.contains('invisible');
    if (!isOpen) return;

    // Clicked directly on the overlay element (outside the form)
    if (e.target === overlay) closeSearchPanel();
  });

  // Esc to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const overlay = document.querySelector('.search-overlay');
      if (overlay && !overlay.classList.contains('invisible')) closeSearchPanel();
    }
  });
</script>

{% comment %} SUGGESTED SEARCH {% endcomment %}
<script>
  (() => {
    const KEY = 'recent_searches_v1',
      MAX_RECENTS = 8,
      MIN_CHARS = 2,
      FETCH_LIMIT = 6, // how many to fetch from predictive
      DISPLAY_MAX = 3; // how many to SHOW in the list

    const esc = (s) =>
      s.replace(/[&<>"']/g, (m) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

    function money(cents) {
      try {
        if (typeof Shopify !== 'undefined' && Shopify.formatMoney) {
          return Shopify.formatMoney(cents, (window.theme && theme.moneyFormat) || '${{amount}}');
        }
      } catch (e) {}
      return (Number(cents || 0) / 100).toLocaleString(undefined, {
        style: 'currency',
        currency: '{{ shop.currency }}',
      });
    }

    // normalize any price → cents (int)
    function toCents(raw) {
      if (raw == null) return null;
      if (typeof raw === 'string') {
        const s = raw.trim();
        if (s === '') return null;
        if (/^\d+$/.test(s)) return parseInt(s, 10); // "1000" (already cents)
        const n = parseFloat(s.replace(/[^\d.]/g, '')); // "$10.00" / "10.00"
        return Number.isFinite(n) ? Math.round(n * 100) : null; // dollars → cents
      }
      if (typeof raw === 'number') {
        return Number.isInteger(raw) ? raw : Math.round(raw * 100);
      }
      return null;
    }

    function recentsGet() {
      try {
        return JSON.parse(localStorage.getItem(KEY)) || [];
      } catch {
        return [];
      }
    }
    function recentsSet(a) {
      localStorage.setItem(KEY, JSON.stringify(a));
    }
    function recentsSave(q) {
      q = (q || '').trim();
      if (!q) return;
      const lower = q.toLowerCase();
      let a = recentsGet().filter((x) => x.toLowerCase() !== lower);
      a.unshift(q);
      recentsSet(a.slice(0, MAX_RECENTS));
    }

    function parts(root) {
      const panel =
        root.closest('.search-panel[role="search"]') || document.querySelector('.search-panel[role="search"]');
      if (!panel) return {};
      return {
        panel,
        input: panel.querySelector('input[name="q"]'),
        recentWrap: panel.querySelector('#SearchRecent'),
        recentList: panel.querySelector('#SearchRecent [data-recent-list]'),
        suggestWrap: panel.querySelector('#SearchSuggestWrap'),
        suggestList: panel.querySelector('#SearchSuggestWrap [data-suggest-products]'),
        searchUrl: panel.getAttribute('action') || '{{ routes.search_url }}',
      };
    }

    const show = (el) => el && el.classList.remove('hidden');
    const hide = (el) => el && el.classList.add('hidden');

    function renderRecents(p) {
      const { recentWrap, recentList, searchUrl } = p;
      if (!recentWrap || !recentList) return;
      const items = recentsGet();
      if (!items.length) {
        hide(recentWrap);
        recentList.innerHTML = '';
        return;
      }
      recentList.innerHTML = items
        .map(
          (q) => `
        <li class="text-xs tracking-[1px]">
          <a class="py-[3px] px-1.5 block w-full lg:w-1/2 rounded hover:bg-[rgba(33,35,34,0.1)] leading-normal font-secondary"
             href="${searchUrl}?q=${encodeURIComponent(q)}&type=product">${esc(q)}</a>
        </li>`
        )
        .join('');
      show(recentWrap);
    }

    let aborter = null;
    async function fetchProducts(q) {
      if (aborter) aborter.abort();
      aborter = new AbortController();
      const url =
        `/search/suggest.json?q=${encodeURIComponent(q)}` +
        `&resources[type]=product` +
        `&resources[limit]=${FETCH_LIMIT}` +
        `&resources[options][unavailable_products]=last`;
      const res = await fetch(url, { signal: aborter.signal, headers: { Accept: 'application/json' } });
      if (!res.ok) return [];
      const data = await res.json();
      return data?.resources?.results?.products || [];
    }

    function renderProducts(p, products, q) {
      const { suggestWrap, suggestList, recentWrap, searchUrl } = p;
      hide(recentWrap);
      show(suggestWrap);

      const shown = products.slice(0, DISPLAY_MAX); // <-- show only 3

      if (!shown.length) {
        suggestList.innerHTML = `
          <li class="text-xs tracking-[1px] opacity-70 px-1.5 py-[9px]">No products found</li>
          <li class="text-xs tracking-[1px]">
            <a class="py-[3px] px-1.5 block w-full lg:w-1/2 rounded hover:bg-[rgba(33,35,34,0.1)] leading-normal font-secondary"
               href="${searchUrl}?q=${encodeURIComponent(q)}&type=product">View all results</a>
          </li>`;
        return;
      }

      suggestList.innerHTML =
        shown
          .map((prod) => {
            // image
            const rawImg =
              prod.image ||
              (prod.images && prod.images[0]) ||
              (prod.featured_image && (prod.featured_image.url || prod.featured_image.src));
            const imgURL = typeof rawImg === 'string' ? rawImg : rawImg && (rawImg.url || rawImg.src);
            const imgHTML = imgURL
              ? `<img class="w-[72px] h-[72px] block object-cover" src="${imgURL}" alt="${esc(prod.title || '')}">`
              : '';

            // price
            let cents = toCents(prod.price_min);
            if (cents == null) cents = toCents(prod.price);
            if (cents == null && prod.variants?.[0]?.price != null) cents = toCents(prod.variants[0].price);

            const priceHTML =
              cents != null
                ? `<span class="py-[3px] block w-full leading-normal font-secondary capitalize">${money(cents)}</span>`
                : '';

            return `
          <li class="text-xs tracking-[1px]">
            <a href="${
              prod.url
            }" class="flex gap-x-[18px] px-1.5 py-[9px] rounded lg:w-1/2 hover:bg-[rgba(33,35,34,0.1)] cursor-pointer">
              ${imgHTML}
              <div>
                <span class="py-[3px] block w-full leading-normal font-secondary capitalize">${esc(prod.title)}</span>
                ${priceHTML}
              </div>
            </a>
          </li>`;
          })
          .join('') +
        `
        <li class="text-xs tracking-[1px] mt-2">
          <a class="py-[3px] px-1.5 block w-full lg:w-1/2 rounded hover:bg-[rgba(33,35,34,0.1)] leading-normal font-secondary"
             href="${searchUrl}?q=${encodeURIComponent(q)}&type=product">View all results</a>
        </li>`;
    }

    const debounce = (fn, ms) => {
      let t;
      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      };
    };
    const onType = debounce(async (e) => {
      const p = parts(e.target);
      const q = (p.input?.value || '').trim();
      if (!p.input) return;

      if (q.length < MIN_CHARS) {
        hide(p.suggestWrap);
        renderRecents(p);
        return;
      }
      const products = await fetchProducts(q);
      renderProducts(p, products, q);
    }, 140);

    // wiring
    document.addEventListener('input', (e) => {
      if (!(e.target instanceof HTMLInputElement)) return;
      if (e.target.name !== 'q') return;
      if (!e.target.closest('.search-panel[role="search"]')) return;
      onType(e);
    });
    document.addEventListener('focusin', (e) => {
      if (!(e.target instanceof HTMLInputElement)) return;
      if (e.target.name !== 'q') return;
      const p = parts(e.target);
      if ((e.target.value || '').trim() === '') renderRecents(p);
    });
    document.addEventListener(
      'submit',
      (e) => {
        const form = e.target.closest('.search-panel[role="search"]');
        if (!form) return;
        const input = form.querySelector('input[name="q"]');
        if (input) recentsSave(input.value);
      },
      true
    );

    // first paint
    document.querySelectorAll('.search-panel[role="search"] input[name="q"]').forEach((inp) => {
      const p = parts(inp);
      if ((inp.value || '').trim() === '') renderRecents(p);
    });
  })();
</script>

{% schema %}
{
  "name": "Header",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "Header Menu",
      "default": "main-menu",
      "info": "Choose your menu"
    },
    {
      "type": "link_list",
      "id": "search_menu",
      "label": "Search Menu",
      "default": "main-menu",
      "info": "Choose your menu for the search component"
    },
    {
      "type": "image_picker",
      "id": "mobilebanner",
      "label": "Mobile Subnav Banner image"
    },
    {
      "type": "text",
      "id": "mobilealt",
      "label": "Mobile Subnav Alt text",
      "default": "Subnav banner"
    }
  ],
  "presets": [
    {
      "name": "Header",
      "category": "Header"
    }
  ]
}
{% endschema %}
